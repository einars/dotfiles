#!/usr/bin/env php
<?php

// run in background, monitor watson (https://github.com/TailorDev/Watson)
// and notify every 15 min 

function watson_state($state_file)
{
    $s = json_decode(file_get_contents($state_file), true);

    if ( ! isset($s['project']) ) {
        return array(null, null);
    }

    $tags = '';
    if (isset($s['tags'])) {
        $tags = ' +' . implode(' +', $s['tags']);
    }

    return [
        $s['project'] . $tags,
        (int)((time() - $s['start']) / 60),
    ];

}

function tell_about($project, $time_elapsed)
{
    if ( $project ) {
        $message = sprintf('Working on %s for %d %s.', $project, $time_elapsed, ($time_elapsed % 10 === 1 && $time_elapsed % 100 !== 11 ? 'minute' : 'minutes'));
    } else {
        $message = 'Doing nothing, just chill.';
    }
    printf("%s %s\n", date('Y-m-d H:i'), $message);
}

function watson_notify($project, $time_elapsed)
{

    $message = sprintf('Working on %s for %d %s.', $project, $time_elapsed, ($time_elapsed % 10 === 1 && $time_elapsed % 100 !== 11 ? 'minute' : 'minutes'));
    printf("%s\n", $message);

    system(sprintf('notify-send -u normal %s', escapeshellarg("Watson\n$message")));
}

function main()
{

    $notification_interval_min = 15;
    $watson_state = getenv('HOME') . '/.config/watson/state';

    if ( ! file_exists($watson_state) ) {
        die("No watson state file $watson_state found.\n");
    }

    $current_proj = null;
    $current_time = null;

    printf("Watson now takes some vicodin.\n");

    $first = true;

    while (true) {
            list($proj, $time) = watson_state($watson_state);

            if ($proj !== $current_proj) {
                tell_about($proj, $time);
            }

            if ( ! $proj ) {
                $current_proj = null;
                $current_time = null;
            }
            else {

                if (($current_time !== $time) and ($time !== 0) and ($time % $notification_interval_min === 0)) {
                    watson_notify($proj, $time);
                }

                $current_time = $time;
                $current_proj = $proj;
            }

        sleep(30);
    }
}

main();
