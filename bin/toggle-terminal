#!/usr/bin/env bash

# -name allows the use of different Xresources
identifier=${1:-global}

session=$identifier # tmux session name

if [ "$identifier" = "global" ]; then
  classname=urxvt.$identifier
  cmd_to_exec="urxvt -name $classname -e tmux-attach-or-create global"
else
  classname=terminal.$identifier 
  #tmux="tmux-attach-or-create $identififer"
  # evilvte seems to have some issues with handling multiple params to executable
  # cmd_to_exec="evilvte --name $classname -e tmux-attach-or-create-local"
  #cmd_to_exec="kitty --name $classname tmux-attach-or-create-local"
  cmd_to_exec="urxvt -name $classname -e tmux-attach-or-create local"
fi

log=/tmp/toggl.log

wid=$(xdotool search --classname $classname 2>&1)
ret=$?

echo $ret >> $log
if [ $ret == 1 ]; then
  # X request probably failed. good riddance
  if echo $wid | grep 'X Error'; then
    exit -1
  fi
fi

if [ -z "$wid" ]; then
  exec $cmd_to_exec &
  sleep 0.05
  xdotool search --classname $classname windowactivate
else
  # multiple windows? take first
  # wid=$(echo $wid | awk '{print $1}')
  #if [ -z "$(xdotool search --onlyvisible --classname $classname)" ]; then
  if [ $(xwininfo -id $wid | grep 'Map State' | awk '{ print $3 }') = "IsUnMapped" ]; then
    xdotool \
      windowmap --sync $wid \
      windowactivate --sync $wid
  else
    xdotool windowunmap --sync $wid
  fi
fi
