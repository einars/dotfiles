#!/bin/bash

set -e

function usage() {
  cat << Usage
Create / update letsencrypt certificates


Usage: 
   ./letsencrypt-update DOMAIN EMAIL
   ./letsencrypt-update "DOMAIN, DOMAIN, DOMAIN" EMAIL

Examples:
   ./letsencrypt-update example.com info@example.com
   ./letsencrypt-update "example.com www.example.com" info@example.com

Usage
}

if [ $# -lt 2 ]; then
  usage
  exit -1
fi


domain=$1
email=${2:-info@kurkur.lv}
letsencrypt=/etc/letsencrypt

account_key=$letsencrypt/letsencrypt.account.key
domain_key=$letsencrypt/letsencrypt.domain.key

test -d /var/www/acme && acme_path=/var/www/acme
test -d /services/web/acme && acme_path=/services/web/acme
if [[ $acme_path == "" ]]; then
    echo Unable to determine acme-path.
    exit -1
fi

multiple=false
if [[ $domain == *" "* ]]; then
  multiple=true
  domains=$domain
  domain=$(echo $domain | sed -r 's/ .*//g')
fi

file=${domain//./_}

cd $letsencrypt

test -f $account_key || openssl genrsa 4096 > $account_key
test -f $domain_key  || openssl genrsa 4096 > $domain_key

test -f $file.csr || {
  if [[ $multiple == "true" ]]; then
    # multiple domains
    # "example.com www.example.com" -> "DNS:example.com,DNS:www.example.com"
    dns_domains=DNS:$(echo $domains | sed -r 's/ /,DNS:/g')
    openssl req -new -sha256 -key $domain_key -subj "/" -reqexts SAN -config <(cat /etc/ssl/openssl.cnf <(printf "[SAN]\nsubjectAltName=$dns_domains")) -out $file.csr
  else
    # single domain
    openssl req -new -key $domain_key -out $file.csr -subj "/C=LV/ST=Riga/L=Riga/O=$domain/emailAddress=$email/CN=$domain"
  fi
}

python2 acme_tiny.py --account-key $account_key --csr ./$file.csr --acme-dir $acme_path > ./$file.crt
wget --quiet -O - https://letsencrypt.org/certs/lets-encrypt-x3-cross-signed.pem > intermediate.pem
cat $file.crt intermediate.pem > $file.pem
